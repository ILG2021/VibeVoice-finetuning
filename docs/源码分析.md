å‡å¦‚audioæ˜¯2ç§’24kçš„éŸ³é¢‘ï¼Œshapeå°±æ˜¯48000ï¼Œvaeå‹ç¼©æ¯”3200ï¼Œæœ‰15ä¸ªvae tokenè¡¨ç¤º

Collatorçš„è¾“å‡ºï¼š
{
    # ========================================
    # input_ids: [batch_size, 81]
    # å±•ç¤ºä¸ºå­—ç¬¦ä¸²ä¾¿äºç†è§£
    # ========================================
    "input_ids": [
        # ===== ä½ç½® 0-20: System Prompt (21 tokens) =====
        " Transform",           # 0
        " the",                 # 1
        " text",                # 2
        " provided",            # 3
        " by",                  # 4
        " various",             # 5
        " speakers",            # 6
        " into",                # 7
        " speech",              # 8
        " output",              # 9
        ",",                    # 10
        " utilizing",           # 11
        " the",                 # 12
        " distinct",            # 13
        " voice",               # 14
        " of",                  # 15
        " each",                # 16
        " respective",          # 17
        " speaker",             # 18
        ".",                    # 19
        "\n",                   # 20
        
        # ===== ä½ç½® 21-28: Voice Prompt Header (8 tokens) =====
        " Voice",               # 21
        " input",               # 22
        ":",                    # 23
        "\n",                   # 24
        " Speaker",             # 25
        " ",                    # 26
        "0",                    # 27
        ":",                    # 28
        
        # ===== ä½ç½® 29: Speech Start Token =====
        "<|speech_start|>",     # 29
        
        # ===== ä½ç½® 30-44: Voice Prompt VAE Tokens (15 tokens) â­ =====
        "<|speech_diffusion|>", # 30
        "<|speech_diffusion|>", # 31
        "<|speech_diffusion|>", # 32
        "<|speech_diffusion|>", # 33
        "<|speech_diffusion|>", # 34
        "<|speech_diffusion|>", # 35
        "<|speech_diffusion|>", # 36
        "<|speech_diffusion|>", # 37
        "<|speech_diffusion|>", # 38
        "<|speech_diffusion|>", # 39
        "<|speech_diffusion|>", # 40
        "<|speech_diffusion|>", # 41
        "<|speech_diffusion|>", # 42
        "<|speech_diffusion|>", # 43
        "<|speech_diffusion|>", # 44
        
        # ===== ä½ç½® 45-46: Voice Prompt End (2 tokens) =====
        "<|speech_end|>",       # 45
        "\n",                   # 46
        
        # ===== ä½ç½® 47-53: Text Input Header (7 tokens) =====
        " Text",                # 47
        " input",               # 48
        ":",                    # 49
        "\n",                   # 50
        " Speaker",             # 51
        " ",                    # 52
        "0",                    # 53
        
        # ===== ä½ç½® 54-58: Text Content (5 tokens) =====
        ":",                    # 54
        " Speaker0",            # 55
        " transcription",       # 56
        ".",                    # 57
        "\n",                   # 58
        
        # ===== ä½ç½® 59-63: Speech Output Header (5 tokens) =====
        " Speech",              # 59
        " output",              # 60
        ":",                    # 61
        "\n",                   # 62
        "<|speech_start|>",     # 63
        
        # ===== ä½ç½® 64-78: Target Audio VAE Tokens (15 tokens) â­â­â­ =====
        # ğŸ”¥ è¿™äº›æ˜¯ Collator æ·»åŠ çš„ï¼Processor è¾“å‡ºä¸­æ²¡æœ‰ï¼
        "<|speech_diffusion|>", # 64 - Target token 1
        "<|speech_diffusion|>", # 65 - Target token 2
        "<|speech_diffusion|>", # 66 - Target token 3
        "<|speech_diffusion|>", # 67 - Target token 4
        "<|speech_diffusion|>", # 68 - Target token 5
        "<|speech_diffusion|>", # 69 - Target token 6
        "<|speech_diffusion|>", # 70 - Target token 7
        "<|speech_diffusion|>", # 71 - Target token 8
        "<|speech_diffusion|>", # 72 - Target token 9
        "<|speech_diffusion|>", # 73 - Target token 10
        "<|speech_diffusion|>", # 74 - Target token 11
        "<|speech_diffusion|>", # 75 - Target token 12
        "<|speech_diffusion|>", # 76 - Target token 13
        "<|speech_diffusion|>", # 77 - Target token 14
        "<|speech_diffusion|>", # 78 - Target token 15
        
        # ===== ä½ç½® 79-80: ç»“æŸæ ‡è®° (2 tokens) =====
        "<|speech_end|>",       # 79
        "<|eos|>"               # 80
    ],
    # æ€»é•¿åº¦: 81 tokens
    
    # ========================================
    # attention_mask: [batch_size, 81]
    # ========================================
    "attention_mask": [
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  # 0-9: System prompt
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  # 10-19
        1, 1, 1, 1, 1, 1, 1, 1, 1,     # 20-28: Voice header
        1,                              # 29: <|speech_start|>
        1, 1, 1, 1, 1,                  # 30-34: Voice VAE (å‰5ä¸ª)
        1, 1, 1, 1, 1,                  # 35-39
        1, 1, 1, 1, 1,                  # 40-44: Voice VAE (å5ä¸ª)
        1, 1,                           # 45-46: <|speech_end|> + \n
        1, 1, 1, 1, 1, 1, 1,            # 47-53: Text header
        1, 1, 1, 1, 1,                  # 54-58: Text content
        1, 1, 1, 1,                     # 59-62: Speech header
        1,                              # 63: <|speech_start|>
        1, 1, 1, 1, 1,                  # 64-68: Target VAE (å‰5ä¸ª)
        1, 1, 1, 1, 1,                  # 69-73
        1, 1, 1, 1, 1,                  # 74-78: Target VAE (å5ä¸ª)
        1, 1                            # 79-80: <|speech_end|> + <|eos|>
    ],
    
    # ========================================
    # acoustic_input_mask: [batch_size, 81]
    # æ ‡è®°å“ªäº›ä½ç½®æ˜¯ acoustic tokens
    # ========================================
    "acoustic_input_mask": [
        # 0-29: æ–‡æœ¬éƒ¨åˆ† - False
        False, False, False, False, False,  # 0-4: " Transform the text provided"
        False, False, False, False, False,  # 5-9: " by various speakers into speech"
        False, False, False, False, False,  # 10-14: ", utilizing the distinct voice"
        False, False, False, False, False,  # 15-19: " of each respective speaker ."
        False,                              # 20: "\n"
        False, False, False, False,         # 21-24: " Voice input :\n"
        False, False, False, False,         # 25-28: " Speaker   0 :"
        False,                              # 29: "<|speech_start|>"
        
        # 30-44: Voice Prompt çš„ VAE tokens - True â­
        True, True, True, True, True,       # 30-34: 5ä¸ª <|speech_diffusion|>
        True, True, True, True, True,       # 35-39: 5ä¸ª <|speech_diffusion|>
        True, True, True, True, True,       # 40-44: 5ä¸ª <|speech_diffusion|>
        
        # 45-63: æ–‡æœ¬éƒ¨åˆ† - False
        False, False,                       # 45-46: "<|speech_end|> \n"
        False, False, False, False,         # 47-50: " Text input :\n"
        False, False, False,                # 51-53: " Speaker   0"
        False, False, False, False, False,  # 54-58: ": Speaker0 transcription .\n"
        False, False, False, False,         # 59-62: " Speech output :\n"
        False,                              # 63: "<|speech_start|>"
        
        # 64-78: Target Audio çš„ VAE tokens - True â­â­â­
        True, True, True, True, True,       # 64-68: 5ä¸ª <|speech_diffusion|>
        True, True, True, True, True,       # 69-73: 5ä¸ª <|speech_diffusion|>
        True, True, True, True, True,       # 74-78: 5ä¸ª <|speech_diffusion|>
        
        # 79-80: ç»“æŸæ ‡è®° - False
        False, False                        # 79-80: "<|speech_end|> <|eos|>"
    ],
    # æ€»å…± 30 ä¸ª True: ä½ç½® 30-44 (voice) + ä½ç½® 64-78 (target)
    
    # ========================================
    # acoustic_loss_mask: [batch_size, 81]
    # æ ‡è®°å“ªäº›ä½ç½®éœ€è¦è®¡ç®— acoustic loss
    # ========================================
    "acoustic_loss_mask": [
        # 0-63: å…¨éƒ¨ False (ä¸è®¡ç®— loss)
        False, False, False, False, False,  # 0-4
        False, False, False, False, False,  # 5-9
        False, False, False, False, False,  # 10-14
        False, False, False, False, False,  # 15-19
        False,                              # 20
        False, False, False, False,         # 21-24
        False, False, False, False,         # 25-28
        False,                              # 29: <|speech_start|>
        
        # âŒ æ³¨æ„: Voice Prompt VAE tokens ä¸è®¡ç®— loss!
        False, False, False, False, False,  # 30-34: Voice VAE
        False, False, False, False, False,  # 35-39
        False, False, False, False, False,  # 40-44
        
        False, False,                       # 45-46
        False, False, False, False,         # 47-50
        False, False, False,                # 51-53
        False, False, False, False, False,  # 54-58
        False, False, False, False,         # 59-62
        False,                              # 63: <|speech_start|>
        
        # 64-78: åªæœ‰ Target VAE tokens è®¡ç®— loss! â­â­â­
        True, True, True, True, True,       # 64-68: Target VAE (è®¡ç®—loss!)
        True, True, True, True, True,       # 69-73
        True, True, True, True, True,       # 74-78
        
        # 79-80: False
        False, False                        # 79-80
    ],
    # åªæœ‰ 15 ä¸ª True: ä»…ä½ç½® 64-78 (target)
    
    # ========================================
    # speech_tensors: [2, 48000]
    # æ‰€æœ‰éŸ³é¢‘æ®µçš„åŸå§‹æ³¢å½¢
    # ========================================
    "speech_tensors": [
        # Segment 0: Voice Prompt Audio (2ç§’ @ 24kHz)
        # å¯¹åº”åºåˆ—ä¸­ä½ç½® 30-44 çš„ 15 ä¸ª VAE tokens
        [
            0.0234, -0.0156, 0.0432, 0.0123, -0.0089,  # å‰5ä¸ªé‡‡æ ·ç‚¹
            0.0167, -0.0234, 0.0056, 0.0345, -0.0123,
            # ... å…± 48000 ä¸ªé‡‡æ ·ç‚¹
            0.0012, -0.0034, 0.0067, 0.0023, -0.0045   # æœ€å5ä¸ªé‡‡æ ·ç‚¹
        ],
        
        # Segment 1: Target Audio (2ç§’ @ 24kHz)
        # å¯¹åº”åºåˆ—ä¸­ä½ç½® 64-78 çš„ 15 ä¸ª VAE tokens
        [
            0.0145, -0.0234, 0.0312, 0.0089, -0.0167,  # å‰5ä¸ªé‡‡æ ·ç‚¹
            0.0234, -0.0123, 0.0078, 0.0256, -0.0189,
            # ... å…± 48000 ä¸ªé‡‡æ ·ç‚¹
            0.0089, -0.0023, 0.0045, 0.0012, -0.0034   # æœ€å5ä¸ªé‡‡æ ·ç‚¹
        ]
    ],
    # shape: (2, 48000)
    
    # ========================================
    # speech_masks: [2, 15]
    # æ¯ä¸ªéŸ³é¢‘æ®µæœ‰å¤šå°‘ä¸ªæœ‰æ•ˆçš„ VAE token
    # ========================================
    "speech_masks": [
        # Segment 0: Voice Prompt - 15ä¸ª VAE tokens å…¨éƒ¨æœ‰æ•ˆ
        # å¯¹åº”ä½ç½® 30-44
        [True, True, True, True, True,      # VAE tokens 0-4
         True, True, True, True, True,      # VAE tokens 5-9
         True, True, True, True, True],     # VAE tokens 10-14
        
        # Segment 1: Target Audio - 15ä¸ª VAE tokens å…¨éƒ¨æœ‰æ•ˆ
        # å¯¹åº”ä½ç½® 64-78
        [True, True, True, True, True,      # VAE tokens 0-4
         True, True, True, True, True,      # VAE tokens 5-9
         True, True, True, True, True]      # VAE tokens 10-14
    ],
    # shape: (2, 15)
    
    # ========================================
    # speeches_loss_input: [2, 15]
    # æ ‡è®°å“ªäº›éŸ³é¢‘æ®µéœ€è¦è®¡ç®— reconstruction loss
    # ========================================
    "speeches_loss_input": [
        # Segment 0: Voice Prompt - ä¸è®¡ç®— loss âŒ
        [False, False, False, False, False,
         False, False, False, False, False,
         False, False, False, False, False],
        
        # Segment 1: Target Audio - è®¡ç®— loss âœ…âœ…âœ…
        [True, True, True, True, True,
         True, True, True, True, True,
         True, True, True, True, True]
    ],
    # shape: (2, 15)
    
    # ========================================
    # speech_semantic_tensors: [2, 15, 128]
    # è¯­ä¹‰ç‰¹å¾ (å¦‚æœ compute_semantics=True)
    # ========================================
    "speech_semantic_tensors": [
        # Segment 0: Voice Prompt çš„è¯­ä¹‰ç‰¹å¾
        # å¯¹åº”ä½ç½® 30-44 çš„ 15 ä¸ª VAE tokens
        [
            [0.123, -0.456, 0.789, ..., 0.012],  # Frame 0 (128ç»´)
            [0.234, -0.567, 0.890, ..., 0.023],  # Frame 1
            [0.345, -0.678, 0.901, ..., 0.034],  # Frame 2
            # ... å…± 15 frames
            [0.456, -0.789, 0.012, ..., 0.045]   # Frame 14
        ],
        
        # Segment 1: Target Audio çš„è¯­ä¹‰ç‰¹å¾
        # å¯¹åº”ä½ç½® 64-78 çš„ 15 ä¸ª VAE tokens
        [
            [0.567, -0.890, 0.123, ..., 0.056],  # Frame 0 (128ç»´)
            [0.678, -0.901, 0.234, ..., 0.067],  # Frame 1
            [0.789, -0.012, 0.345, ..., 0.078],  # Frame 2
            # ... å…± 15 frames
            [0.890, -0.123, 0.456, ..., 0.089]   # Frame 14
        ]
    ]
    # shape: (2, 15, 128)
}
```

---

## å¯è§†åŒ–å¯¹ç…§è¡¨
```
ä½ç½®    Token æ–‡æœ¬                      acoustic_input  acoustic_loss   è¯´æ˜
                                        _mask           _mask
================================================================================
0-20    System Prompt æ–‡æœ¬              False           False           ç³»ç»Ÿæç¤º
21-28   Voice header æ–‡æœ¬               False           False           è¯­éŸ³è¾“å…¥å¤´
29      <|speech_start|>               False           False           å¼€å§‹æ ‡è®°

30      <|speech_diffusion|>            âœ… True         âŒ False         Voice VAE 1
31      <|speech_diffusion|>            âœ… True         âŒ False         Voice VAE 2
32      <|speech_diffusion|>            âœ… True         âŒ False         Voice VAE 3
...     ...                             âœ… True         âŒ False         ...
44      <|speech_diffusion|>            âœ… True         âŒ False         Voice VAE 15

45      <|speech_end|>                  False           False           ç»“æŸæ ‡è®°
46-58   Text input æ–‡æœ¬                  False           False           æ–‡æœ¬è¾“å…¥
59-62   Speech output header            False           False           è¯­éŸ³è¾“å‡ºå¤´
63      <|speech_start|>                False           False           å¼€å§‹æ ‡è®°

64      <|speech_diffusion|>            âœ… True         âœ… True          Target VAE 1 ğŸ”¥
65      <|speech_diffusion|>            âœ… True         âœ… True          Target VAE 2 ğŸ”¥
66      <|speech_diffusion|>            âœ… True         âœ… True          Target VAE 3 ğŸ”¥
...     ...                             âœ… True         âœ… True          ...
78      <|speech_diffusion|>            âœ… True         âœ… True          Target VAE 15 ğŸ”¥

79      <|speech_end|>                  False           False           ç»“æŸæ ‡è®°
80      <|eos|>                         False           False           EOSæ ‡è®°